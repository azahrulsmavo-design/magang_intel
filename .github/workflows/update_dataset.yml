name: Update dataset (MagangHub)

on:
  schedule:
    - cron: "0 */12 * * *"     # tiap 12 jam
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0       # penting supaya bisa pull/rebase
          ref: main            # pastikan kita kerja di branch main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pandas pyarrow requests pyyaml

      # 1) Jalankan pipeline: fetch -> prepare -> score
      - name: Run fetch + prepare + score
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          python src/fetch.py
          python -m src.prepare
          python -m src.score || echo "[WARN] score.py optional"

      # 2) Arsip RAW jadi zip + upload artifact (retensi 30 hari)
      - name: Archive RAW to zip
        run: |
          python - <<'PY'
          import glob, shutil, os
          runs = sorted([p for p in glob.glob('data/raw/run_*') if os.path.isdir(p)])
          if runs:
              latest = runs[-1]
              shutil.make_archive(latest, 'zip', latest)
              print("Zipped:", latest + '.zip')
          else:
              print("No raw folder found.")
          PY

      - name: Upload RAW artifact (30 days)
        uses: actions/upload-artifact@v4
        with:
          name: maganghub-raw-${{ github.run_id }}
          path: data/raw/run_*.zip
          retention-days: 30

      # 3) Convert Parquet to JSON untuk web
      - name: Convert data to JSON
        run: |
          python web/scripts/convert_data.py

      # 4) Commit & Push Data (Triggers Vercel)
      - name: Commit and Push Data
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          # pastikan dulu main kita up-to-date
          git pull --rebase origin main

          git add data/clean/vacancies.parquet web/public/data.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto-update data ($(date -u +'%Y-%m-%d %H:%M:%S'))"
            git push origin main
          fi
